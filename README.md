------

# 2025年中国大学生工程实践与创新能力大赛 - 视觉识别与UART通信

> Project Name: GC-2025-Vision
>
> Author: Forest Wolves Robot Team (Jees996)
>
> Device: OpenMV Cam H7/Plus

## 📖 项目简介

本项目为 **2025年中国大学生工程实践与创新能力大赛** 智能物流/搬运机器人的视觉识别模块源码。代码基于 MicroPython 编写，运行于 **OpenMV** 智能摄像头平台。

主要功能包括：

1. **多色块物料识别**：基于 HSV 阈值识别红、绿、蓝三种颜色的物料。
2. **精准定位引导**：计算目标物料相对于视野中心的 X/Y 轴偏差，辅助机械臂或车体对准。
3. **特定形状识别**：识别绿色/蓝色圆环（用于特定任务点）。
4. **双向串口通信**：
   - **接收**：从主控（STM32）接收目标颜色顺序、任务阶段（状态机）等指令。
   - **发送**：向主控发送抓取许可标志、位置偏差数据。

## 🛠️ 硬件与环境

- **硬件平台**: OpenMV Cam (推荐 H7 或 Plus 版本)
- **开发语言**: MicroPython
- **IDE**: OpenMV IDE
- **通信接口**: UART (P4-TX, P5-RX), 波特率 115200

## ⚙️ 核心功能与逻辑

### 1. 状态机模式 (State Switching)

系统根据串口接收到的 `car_state` 变量切换工作模式：

- **模式 1 / 3 (物料识别)**: 调用 `color_track()`，识别指定颜色的矩形色块。
- **模式 2 (色环识别)**: 调用 `find_green_circles()`，识别圆形目标。

### 2. 视觉定位算法

代码设定了一个虚拟的“中心瞄准框”：

- **中心坐标**: `center_x = 70`, `center_y = 60`
- **容差范围**: `side_length = 8`

系统会将识别到的物体中心 `(x, y)` 与瞄准框对比，并输出偏差值：

- **Xx (X轴偏差)**: 0=居中, 1=偏左, 2=偏右
- **Xy (Y轴偏差)**: 0=居中, 1=偏上, 2=偏下
- **Position Flag**: 当 X 和 Y 均居中时，置 1。

### 3. 颜色阈值 (LAB)

*请根据现场光线环境通过 OpenMV IDE 的阈值编辑器进行微调*

Python

```
Goods_thresholds = [
    (39, 74, 18, 82, 14, 78),    # 红色 Red
    (57, 77, -19, -63, 27, 3),   # 绿色 Green
    (42, 78, 12, -24, -12, -56), # 蓝色 Blue
]
```

## 📡 通信协议 (UART Protocol)

波特率: 115200

校验位: 无

### 📤 发送协议 (OpenMV -> STM32)

数据包长度：8 Byte

格式：<BBBBBBBB (Little Endian)

| **字节索引** | **内容 (Hex)** | **含义/变量名** | **说明**                                                     |
| ------------ | -------------- | --------------- | ------------------------------------------------------------ |
| 0            | **0xA5**       | 帧头1           | 固定帧头                                                     |
| 1            | **0xA6**       | 帧头2           | 固定帧头                                                     |
| 2            | 0x01           | c1              | 固定值 (保留位)                                              |
| 3            | 0x00/0x01      | **catch_flag**  | **1**: 允许抓取 (位置正确且颜色匹配) **0**: 禁止抓取         |
| 4            | 0/1/2          | **Xx**          | **0**: 居中 **1**: 物体在左，车需左移 **2**: 物体在右，车需右移 |
| 5            | 0/1/2          | **Xy**          | **0**: 居中 **1**: 物体在上，车需前进 **2**: 物体在下，车需后退 |
| 6            | 0x00           | c5              | 固定值 (保留位)                                              |
| 7            | **0x5B**       | 帧尾            | 固定帧尾                                                     |

### 📥 接收协议 (STM32 -> OpenMV)

采用状态机逐字节解析，帧头为 `0xDF`。

| **顺序** | **变量名**          | **说明**                                         |
| -------- | ------------------- | ------------------------------------------------ |
| 1        | Frame Header        | **0xDF**                                         |
| 2        | `color_number[0]`   | 任务目标颜色1                                    |
| 3        | `color_number[1]`   | 任务目标颜色2                                    |
| 4        | `color_number[2]`   | 任务目标颜色3                                    |
| 5        | `car_state`         | **1/3**: 识别物料 **2**: 识别色环 **其他**: 待机 |
| 6        | `color_change_flag` | 颜色切换标志 (未使用)                            |
| 7        | `color_step`        | 当前处于第几步 (用于选择目标颜色 1/2/3)          |

## 🚀 快速开始

1. **安装**: 下载 OpenMV IDE 并连接摄像头。
2. **烧录**: 将 `Eng-Prac-2025.py` 内容复制到 IDE 中，或保存为 `main.py` 存入 OpenMV 的 U盘根目录（实现脱机运行）。
3. **调参**:
   - 打开 Tools -> Machine Vision -> Threshold Editor。
   - 针对红、绿、蓝物料调整 `Goods_thresholds`。
   - 修改 `center_x` 和 `center_y` 以匹配你的摄像头安装角度。
4. **调试**:
   - 将 `DEBUG = True`。
   - 在 IDE 的帧缓冲区查看识别框和中心十字。
   - 在串行终端查看打印的调试信息。

## ⚠️ 注意事项

1. **光线影响**: 比赛场地光线变化极大，务必在比赛现场重新校准 LAB 阈值。
2. **通信同步**: 确保 STM32 端接收解析代码与上述发送协议严格一致，特别是帧头帧尾。
3. **对焦**: 记得手动旋转镜头调整焦距，确保物料清晰。

------

*Copyright © 2025 Jees996 (Leexian) @ BJFU Forestry Wolves. All Rights Reserved.*
